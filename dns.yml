---
- name: Set DNS servers for all Debian servers
  hosts: debian_hosts
  become: yes
  tasks:
    - name: Ensure NetworkManager is installed
      apt:
        name: network-manager
        state: present

    - name: Set primary DNS server using nmcli
      command: nmcli con mod "{{ item }}" ipv4.dns "10.10.80.21"
      with_items: "{{ ansible_interfaces }}"
      when: item != "lo" # excluding the loopback interface

    - name: Add secondary DNS server using nmcli
      command: nmcli con mod "{{ item }}" +ipv4.dns "10.10.80.22"
      with_items: "{{ ansible_interfaces }}"
      when: item != "lo"

    - name: Add tertiary DNS server using nmcli
      command: nmcli con mod "{{ item }}" +ipv4.dns "8.8.8.8"
      with_items: "{{ ansible_interfaces }}"
      when: item != "lo"

    - name: Restart NetworkManager to apply DNS changes
      service:
        name: NetworkManager
        state: restarted
